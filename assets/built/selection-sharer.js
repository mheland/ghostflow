!function(l){function n(e){var a=this;"string"==typeof(e=e||{})&&(e={elements:e}),this.sel=null,this.textSelection="",this.htmlSelection="",this.appId=l('meta[property="fb:app_id"]').attr("content")||l('meta[property="fb:app_id"]').attr("value"),this.url2share=l('meta[property="og:url"]').attr("content")||l('meta[property="og:url"]').attr("value")||window.location.href,this.getSelectionText=function(e){var t="",o="";if((e=e||window.getSelection()).rangeCount){for(var n=document.createElement("div"),i=0,r=e.rangeCount;i<r;++i)n.appendChild(e.getRangeAt(i).cloneContents());o=n.textContent,t=n.innerHTML}return a.textSelection=o,a.htmlSelection=t||o,o},this.selectionDirection=function(e){var t=e||window.getSelection(),o=document.createRange();if(!t.anchorNode)return 0;o.setStart(t.anchorNode,t.anchorOffset),o.setEnd(t.focusNode,t.focusOffset);var n=o.collapsed?"backward":"forward";return o.detach(),n},this.showPopunder=function(){a.popunder=a.popunder||document.getElementById("selectionSharerPopunder");var e=window.getSelection(),t=a.getSelectionText(e);if(e.isCollapsed||t.length<10||!t.match(/ /))return a.hidePopunder();if(a.popunder.classList.contains("fixed"))return a.popunder.style.bottom=0,a.popunder.style.bottom;var o=e.getRangeAt(0).endContainer.parentNode;if(a.popunder.classList.contains("show")){if(Math.ceil(a.popunder.getBoundingClientRect().top)==Math.ceil(o.getBoundingClientRect().bottom))return;return a.hidePopunder(a.showPopunder)}if(o.nextElementSibling)a.pushSiblings(o);else{a.placeholder||(a.placeholder=document.createElement("div"),a.placeholder.className="selectionSharerPlaceholder");var n=window.getComputedStyle(o).marginBottom;a.placeholder.style.height=n,a.placeholder.style.marginBottom=-2*parseInt(n,10)+"px",o.parentNode.insertBefore(a.placeholder)}var i=window.pageYOffset+o.getBoundingClientRect().bottom;a.popunder.style.top=Math.ceil(i)+"px",setTimeout(function(){a.placeholder&&a.placeholder.classList.add("show"),a.popunder.classList.add("show")},0)},this.pushSiblings=function(e){for(;e=e.nextElementSibling;)e.classList.add("selectionSharer"),e.classList.add("moveDown")},this.hidePopunder=function(e){if(e=e||function(){},"fixed"==a.popunder)return a.popunder.style.bottom="-50px",e();var t;a.popunder.classList.remove("show"),a.placeholder&&a.placeholder.classList.remove("show");for(var o=document.getElementsByClassName("moveDown");t=o[0];)t.classList.remove("moveDown");setTimeout(function(){a.placeholder&&document.body.insertBefore(a.placeholder),e()},600)},this.show=function(r){setTimeout(function(){var e=window.getSelection(),t=a.getSelectionText(e);if(!e.isCollapsed&&t&&10<t.length&&t.match(/ /)){var o=e.getRangeAt(0).getBoundingClientRect().top-5+a.getPosition().y-a.$popover.height(),n=0;if(r)n=r.pageX;else{var i=e.anchorNode.parentNode;for(n+=i.offsetWidth/2;n+=i.offsetLeft,i=i.offsetParent;);}switch(a.selectionDirection(e)){case"forward":n-=a.$popover.width();break;case"backward":n+=a.$popover.width();break;default:return}a.$popover.removeClass("anim").css("top",10+o).css("left",n).show(),setTimeout(function(){a.$popover.addClass("anim").css("top",o)},0)}},10)},this.hide=function(){a.$popover.hide()},this.smart_truncate=function(e,t){if(!e||!e.length)return e;var o=e.length>t,n=o?e.substr(0,t-1):e;return n=o?n.substr(0,n.lastIndexOf(" ")):n,o?n+"...":n},this.getRelatedTwitterAccounts=function(){var e=[],t=l('meta[name="twitter:creator"]').attr("content")||l('meta[name="twitter:creator"]').attr("value");t&&e.push(t);for(var o=document.getElementsByTagName("a"),n=0,i=o.length;n<i;n++)if(o[n].attributes.href&&"string"==typeof o[n].attributes.href.value){var r=o[n].attributes.href.value.match(/^https?:\/\/twitter\.com\/([a-z0-9_]{1,20})/i);r&&1<r.length&&-1==["widgets","intent"].indexOf(r[1])&&e.push(r[1])}return 0<e.length?e.join(","):""},this.shareTwitter=function(e){e.preventDefault();var t="“"+a.smart_truncate(a.textSelection.trim(),114)+"”",o="http://twitter.com/intent/tweet?text="+encodeURIComponent(t)+"&related="+a.getRelatedTwitterAccounts()+"&url="+encodeURIComponent(a.url2share);a.viaTwitterAccount&&t.length<114-a.viaTwitterAccount.length&&(o+="&via="+a.viaTwitterAccount);var n=screen.width/2-320,i=screen.height/2-220-100;return window.open(o,"share_twitter","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=640, height=440, top="+i+", left="+n),a.hide(),!1},this.shareFacebook=function(e){e.preventDefault();var t=a.htmlSelection.replace(/<p[^>]*>/gi,"\n").replace(/<\/p>| {2}/gi,"").trim(),o="https://www.facebook.com/dialog/feed?app_id="+a.appId+"&display=popup&caption="+encodeURIComponent(t)+"&link="+encodeURIComponent(a.url2share)+"&href="+encodeURIComponent(a.url2share)+"&redirect_uri="+encodeURIComponent(a.url2share),n=screen.width/2-320,i=screen.height/2-220-100;window.open(o,"share_facebook","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=640, height=440, top="+i+", left="+n)},this.shareLinkedIn=function(e){e.preventDefault();var t=a.htmlSelection.replace(/<p[^>]*>/gi,"\n").replace(/<\/p>| {2}/gi,"").trim(),o="https://www.linkedin.com/shareArticle?mini=true&url="+encodeURIComponent(a.url2share)+"&title="+encodeURIComponent(t),n=screen.width/2-320,i=screen.height/2-220-100;window.open(o,"share_linkedin","toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=640, height=440, top="+i+", left="+n)},this.shareEmail=function(){var e=a.textSelection.replace(/<p[^>]*>/gi,"\n").replace(/<\/p>| {2}/gi,"").trim(),t={};return t.subject=encodeURIComponent("Quote from "+document.title),t.body=encodeURIComponent("“"+e+"”")+"%0D%0A%0D%0AFrom: "+document.title+"%0D%0A"+window.location.href,l(this).attr("href","mailto:?subject="+t.subject+"&body="+t.body),a.hide(),!0},this.render=function(){a.$popover=l('<div class="selectionSharer" id="selectionSharerPopover" style="position:absolute;">  <div id="selectionSharerPopover-inner">    <ul>      <li><a class="action tweet" href="" title="Dela markering på Twitter" target="_blank">Tweet</a></li>      <li><a class="action facebook" href="" title="Dela markering på  Facebook" target="_blank">Facebook</a></li>      <li><a class="action linkedin" href="" title="Dela markering på  LinkedIn" target="_blank">LinkedIn</a></li>      <li><a class="action email" href="" title="Dela markering med epost" target="_blank"><svg width="20" height="20"><path stroke="%23FFF" stroke-width="6" d="m16,25h82v60H16zl37,37q4,3 8,0l37-37M16,85l30-30m22,0 30,30"/></svg></a></li>    </ul>  </div>  <div class="selectionSharerPopover-clip"><span class="selectionSharerPopover-arrow"></span></div></div>'),a.$popover.find("a.tweet").click(a.shareTwitter),a.$popover.find("a.facebook").click(a.shareFacebook),a.$popover.find("a.linkedin").click(a.shareLinkedIn),a.$popover.find("a.email").click(a.shareEmail),l("body").append(a.$popover),a.$popunder=l('<div id="selectionSharerPopunder" class="selectionSharer">  <div id="selectionSharerPopunder-inner">    <label>Share this selection</label>    <ul>      <li><a class="action tweet" href="" title="Dela markering på Twitter" target="_blank">Tweet</a></li>      <li><a class="action facebook" href="" title="Dela markering på Facebook" target="_blank">Facebook</a></li>      <li><a class="action linkedin" href="" title="Dela markering på LinkedIn" target="_blank">LinkedIn</a></li>      <li><a class="action email" href="" title="Dela markering med epost" target="_blank"><svg width="20" height="20"><path stroke="%23FFF" stroke-width="6" d="m16,25h82v60H16zl37,37q4,3 8,0l37-37M16,85l30-30m22,0 30,30"/></svg></a></li>    </ul>  </div></div>'),a.$popunder.find("a.tweet").click(a.shareTwitter),a.$popunder.find("a.facebook").click(a.shareFacebook),a.$popover.find("a.linkedin").click(a.shareLinkedIn),a.$popunder.find("a.email").click(a.shareEmail),l("body").append(a.$popunder),a.appId&&a.url2share&&l(".selectionSharer a.facebook").css("display","inline-block")},this.setElements=function(e){"string"==typeof e&&(e=l(e)),a.$elements=e instanceof l?e:l(e),a.$elements.mouseup(a.show).mousedown(a.hide).addClass("selectionShareable"),a.$elements.bind("touchstart",function(){a.isMobile=!0}),document.onselectionchange=a.selectionChanged},this.selectionChanged=function(e){a.isMobile&&(a.lastSelectionChanged&&clearTimeout(a.lastSelectionChanged),a.lastSelectionChanged=setTimeout(function(){a.showPopunder(e)},300))},this.getPosition=function(){var e=void 0!==window.pageXOffset,t="CSS1Compat"===(document.compatMode||"");return{x:e?window.pageXOffset:t?document.documentElement.scrollLeft:document.body.scrollLeft,y:e?window.pageYOffset:t?document.documentElement.scrollTop:document.body.scrollTop}},this.render(),e.elements&&this.setElements(e.elements)}l.fn.selectionSharer=function(){return(new n).setElements(this),this},"function"==typeof define?define(function(){return n.load=function(e,t,o){(new n).setElements("p"),o()},n}):"object"==typeof module&&module.exports?module.exports=n:window.SelectionSharer=n}(jQuery);
//# sourceMappingURL=selection-sharer.js.map